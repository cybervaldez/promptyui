<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>PromptyUI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="vendor/quill/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="pu-app" data-testid="pu-app">
        <!-- Header -->
        <header class="pu-header" data-testid="pu-header">
            <div class="pu-header-left">
                <button class="pu-btn pu-mobile-panel-btn" data-testid="pu-mobile-sidebar-btn"
                        onclick="PU.sidebar.togglePanel()">&#9776;</button>
                <span class="pu-header-title">PromptyUI</span>
            </div>
            <div class="pu-header-center">
                <span class="pu-header-active-label">&#9656;</span>
                <span class="pu-header-active-job" data-testid="pu-header-active-job">No job selected</span>
            </div>
            <div class="pu-header-right">
                <button class="pu-btn" data-testid="pu-header-build-btn" onclick="PU.buildComposition.toggle()">
                    Build
                </button>
                <button class="pu-btn pu-btn-primary" data-testid="pu-header-export-btn" onclick="PU.actions.openExportModal()">
                    Export
                </button>
                <button class="pu-btn pu-btn-help" data-testid="pu-header-help-btn" onclick="PU.actions.showHelp()">
                    ?
                </button>
                <button class="pu-btn pu-mobile-panel-btn" data-testid="pu-mobile-rp-btn"
                        onclick="PU.rightPanel.togglePanel()">&#9881;</button>
            </div>
        </header>

        <!-- Main 3-Panel Layout -->
        <div class="pu-main">
            <!-- Left Sidebar (Jobs only - Extensions in right inspector) -->
            <aside class="pu-sidebar" data-testid="pu-sidebar">
                <!-- Jobs Section -->
                <section class="pu-sidebar-section pu-jobs-section" data-testid="pu-jobs-section">
                    <div class="pu-sidebar-header">
                        <span class="pu-sidebar-title">JOBS</span>
                        <span class="pu-jobs-count" data-testid="pu-jobs-count"></span>
                        <button class="pu-panel-collapse-btn" data-testid="pu-sidebar-collapse-btn"
                                onclick="event.stopPropagation(); PU.sidebar.togglePanel()" title="Collapse sidebar ([)">&#9664;</button>
                    </div>
                    <div class="pu-sidebar-content pu-jobs-tree" data-testid="pu-jobs-tree">
                        <!-- Jobs tree rendered by JS -->
                        <div class="pu-loading">Loading jobs...</div>
                    </div>
                    <div class="pu-sidebar-footer">
                        <button class="pu-btn pu-btn-full" data-testid="pu-new-job-btn" onclick="PU.actions.createNewJob()">
                            + New Job
                        </button>
                    </div>
                </section>
            </aside>

            <!-- Center Editor -->
            <main class="pu-editor" data-testid="pu-editor">
                <!-- No Prompts State (job selected but 0 prompts) -->
                <div class="pu-editor-no-prompts" data-testid="pu-editor-no-prompts" style="display: none;">
                    <div style="opacity: 0.3; font-size: 48px; margin-bottom: var(--pu-space-lg);">&#128196;</div>
                    <h3>No prompts yet</h3>
                    <p>Add your first prompt to start building.</p>
                    <button class="pu-btn pu-btn-ghost" data-testid="pu-add-first-prompt-btn"
                            onclick="PU.actions.createNewPrompt(PU.state.activeJobId)">
                        + Add Prompt
                    </button>
                </div>

                <!-- Prompt Editor (hidden until job selected) -->
                <div class="pu-editor-content" data-testid="pu-editor-content" style="display: none;">
                    <!-- Prompt Title -->
                    <div class="pu-prompt-header">
                        <span class="pu-prompt-label">PROMPT:</span>
                        <span class="pu-prompt-title" data-testid="pu-editor-title">No prompt selected</span>
                        <span class="pu-prompt-save-state" data-testid="pu-prompt-save-state" style="display: none;">
                            <span class="pu-save-badge" data-testid="pu-save-badge">(modified)</span>
                            <button class="pu-save-btn" data-testid="pu-save-btn"
                                    onclick="PU.editor.savePrompt()">Save</button>
                        </span>
                        <div class="pu-prompt-header-actions">
                            <select data-testid="pu-editor-visualizer"
                                    onchange="PU.editor.handleVisualizerChange(this.value)">
                                <option value="compact">Compact</option>
                                <option value="typewriter">Typewriter</option>
                                <option value="reel">Reel</option>
                                <option value="stack">Stack</option>
                                <option value="ticker">Ticker</option>
                            </select>
                        </div>
                    </div>

                    <!-- Blocks Container -->
                    <div class="pu-blocks-container" data-testid="pu-blocks-container">
                        <!-- Blocks rendered by JS -->
                    </div>

                    <!-- Add Block Buttons -->
                    <div class="pu-add-block-area">
                        <div class="pu-add-root-dropdown" data-testid="pu-add-root-dropdown">
                            <button class="pu-btn" onclick="PU.actions.toggleAddMenu()">+ Add Root Block &#9660;</button>
                            <div class="pu-add-menu" style="display: none;">
                                <button data-testid="pu-add-content-btn" onclick="PU.actions.addBlock('content')">
                                    Add Content Input
                                </button>
                                <button data-testid="pu-add-exttext-btn" onclick="PU.actions.addBlock('ext_text')">
                                    Add Theme
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </main>

            <!-- Right Panel (wildcard stream + compositions) -->
            <aside class="pu-right-panel" data-testid="pu-right-panel">
                <!-- Top bar: scope + variant selector + wc count + collapse toggle -->
                <div class="pu-rp-top-bar" data-testid="pu-rp-top-bar" style="position: relative;">
                    <span class="pu-rp-scope-chip" data-testid="pu-rp-scope"></span>
                    <span class="pu-rp-top-sep"></span>
                    <span class="pu-rp-op-selector" data-testid="pu-rp-op-selector"></span>
                    <span class="pu-rp-top-spacer"></span>
                    <span class="pu-rp-top-stats" data-testid="pu-rp-wc-count"></span>
                    <button class="pu-panel-collapse-btn" data-testid="pu-rp-collapse-btn"
                            onclick="PU.rightPanel.togglePanel()" title="Collapse panel (])">&#9654;</button>
                    <!-- Operation dropdown (hidden by default) -->
                    <div class="pu-rp-op-dropdown" data-testid="pu-rp-op-dropdown" style="display: none;"></div>
                </div>
                <!-- Job Defaults (collapsible) -->
                <div class="pu-rp-defaults" data-testid="pu-rp-defaults">
                    <div class="pu-rp-defaults-header" onclick="PU.rightPanel.toggleDefaults()">
                        <span>JOB DEFAULTS</span>
                        <button class="pu-rp-defaults-toggle" data-testid="pu-rp-defaults-toggle">&#9660;</button>
                    </div>
                    <div class="pu-rp-defaults-body" data-testid="pu-rp-defaults-body">
                        <div class="pu-rp-defaults-inner">
                            <div class="pu-rp-defaults-row" data-testid="pu-rp-defaults-ext-row">
                                <label>ext:</label>
                                <select data-testid="pu-defaults-ext"
                                        onchange="PU.actions.updateDefaults('ext', this.value)">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="pu-rp-defaults-no-ext" data-testid="pu-defaults-no-ext" style="display: none;">
                                <span>No extension themes installed</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Wildcard stream (scrollable, relative for popover positioning) -->
                <div class="pu-rp-wc-stream" data-testid="pu-rp-wc-stream" style="position: relative;">
                    <div class="pu-rp-note">No wildcards or themes yet. The panel shows the composition navigator once wildcards are added.</div>
                </div>

                <!-- Replacement popover (hidden by default, positioned absolutely) -->
                <div class="pu-rp-replace-popover" data-testid="pu-rp-replace-popover" style="display: none;"></div>

                <!-- Push-to-theme popover (hidden by default, positioned absolutely) -->
                <div class="pu-rp-push-popover" data-testid="pu-rp-push-popover" style="display: none;"></div>

                <!-- Compositions section (fixed bottom) -->
                <div class="pu-rp-ops-section" data-testid="pu-rp-ops-section">
                    <!-- Rendered by JS -->
                </div>
            </aside>
        </div>

        <!-- Footer Helper Bar -->
        <footer class="pu-footer" data-testid="pu-footer">
            <div class="pu-footer-shortcuts" data-testid="pu-footer-shortcuts">
                <span class="pu-footer-prefix">Keyboard Shortcuts</span>
                <span class="pu-footer-sep">&mdash;</span>
                <span class="pu-footer-label" data-testid="pu-footer-job-browser"
                      onclick="PU.sidebar.togglePanel()">Open</span>
                <kbd>[</kbd>
                <span class="pu-footer-comma">,</span>
                <span class="pu-footer-label" data-testid="pu-footer-composer"
                      onclick="PU.rightPanel.togglePanel()">Compose</span>
                <kbd>]</kbd>
            </div>
            <div class="pu-footer-tip" data-testid="pu-footer-tip"></div>
        </footer>

        <!-- Focus Mode Overlay -->
        <div class="pu-focus-overlay" data-testid="pu-focus-overlay" style="display: none;"
             onclick="PU.focus.handleOverlayClick(event)">
            <div class="pu-focus-panel" data-testid="pu-focus-panel" onclick="event.stopPropagation()">
                <div class="pu-focus-header" data-testid="pu-focus-header">
                    <span class="pu-focus-title" data-testid="pu-focus-title"></span>
                    <button class="pu-focus-close" data-testid="pu-focus-close-btn"
                            onclick="PU.focus.exit()">&times;</button>
                </div>
                <div class="pu-focus-editor" data-testid="pu-focus-editor">
                    <div class="pu-focus-quill" data-testid="pu-focus-quill"></div>
                </div>
                <div class="pu-focus-output pu-output-footer" data-testid="pu-focus-output">
                    <div class="pu-output-footer-header" data-testid="pu-focus-output-toggle"
                         onclick="PU.focus.toggleOutput()">
                        <span class="pu-output-footer-title">Resolved Output</span>
                        <span class="pu-output-footer-count" data-testid="pu-focus-output-count"></span>
                        <span class="pu-output-filter-badge" data-testid="pu-focus-filter-badge" style="display:none"></span>
                        <button class="pu-btn-sm pu-output-label-toggle"
                                data-testid="pu-focus-label-toggle"
                                onclick="event.stopPropagation(); PU.focus.cycleLabelMode()"
                                title="Label mode: none">&#8210;</button>
                        <button class="pu-btn-sm" data-testid="pu-focus-output-copy"
                                onclick="event.stopPropagation(); PU.focus.copyOutput()">Copy All</button>
                        <span class="pu-output-footer-chevron" data-testid="pu-focus-output-chevron">&#9660;</span>
                    </div>
                    <div class="pu-output-footer-body" data-testid="pu-focus-output-body">
                        <div class="pu-filter-tree" data-testid="pu-focus-filter-tree" style="display:none">
                            <div class="pu-filter-tree-scroll" data-testid="pu-focus-filter-scroll"></div>
                            <div class="pu-filter-tree-footer">
                                <button class="pu-filter-reset-btn" data-testid="pu-focus-filter-reset"
                                        style="display:none"
                                        onclick="event.stopPropagation(); PU.focus.resetFilters()">
                                    <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 1l10 10M11 1L1 11"/></svg>
                                    RESET
                                </button>
                            </div>
                        </div>
                        <div class="pu-focus-output-right" data-testid="pu-focus-output-right">
                            <div class="pu-output-list" data-testid="pu-focus-output-list"></div>
                            <div class="pu-focus-legend-strip" data-testid="pu-focus-include-footer">
                                <span class="pu-focus-legend-item pu-legend-parent" data-testid="pu-focus-legend-parent">
                                    <span class="pu-legend-dot"></span>
                                    <span class="pu-legend-label">Parent</span>
                                </span>
                                <span class="pu-focus-legend-item pu-legend-self" data-testid="pu-focus-legend-self">
                                    <span class="pu-legend-dot"></span>
                                    <span class="pu-legend-label">This Block</span>
                                </span>
                                <label class="pu-focus-legend-item pu-legend-child" data-testid="pu-focus-include-children-label">
                                    <span class="pu-legend-dot"></span>
                                    <span class="pu-legend-label">Children</span>
                                    <input type="checkbox" checked
                                           data-testid="pu-focus-include-children"
                                           onchange="PU.focus.toggleIncludeChildren(this.checked)">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Build Composition Panel (slide-out) -->
        <div class="pu-build-panel" data-testid="pu-build-panel" style="display: none;">
            <div class="pu-build-header">
                <span class="pu-build-title">BUILD COMPOSITION</span>
                <button class="pu-focus-close" data-testid="pu-build-close-btn"
                        onclick="PU.buildComposition.close()">&times;</button>
            </div>
            <div class="pu-build-body">
                <!-- Defaults Section -->
                <div class="pu-build-section">
                    <div class="pu-build-section-label">DEFAULTS</div>
                    <div class="pu-build-section-hint">Shared across all prompts</div>
                    <div class="pu-build-defaults-form">
                        <div class="pu-build-field">
                            <label>ext scope:</label>
                            <select data-testid="pu-build-defaults-ext"
                                    onchange="PU.buildComposition.updateDefault('ext', this.value)">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="pu-build-field">
                            <label>ext_text_max:</label>
                            <input type="number" min="0" value="0"
                                   data-testid="pu-build-defaults-ext-text-max"
                                   onchange="PU.buildComposition.updateDefault('ext_text_max', this.value)">
                            <span class="pu-build-hint">0 = all</span>
                        </div>
                        <div class="pu-build-field">
                            <label>wc_max:</label>
                            <input type="number" min="0" value="0"
                                   data-testid="pu-build-defaults-ext-wc-max"
                                   onchange="PU.buildComposition.updateDefault('wildcards_max', this.value)">
                            <span class="pu-build-hint">0 = all</span>
                        </div>
                    </div>
                </div>

                <!-- Prompt Section -->
                <div class="pu-build-section">
                    <div class="pu-build-section-label">PROMPT</div>
                    <div data-testid="pu-build-prompt-section"></div>
                </div>

                <!-- Operation Section (Phase 2 stub) -->
                <div class="pu-build-section">
                    <div class="pu-build-section-label">OPERATION</div>
                    <div data-testid="pu-build-operation-section">
                        <div class="pu-build-empty">None</div>
                    </div>
                </div>

                <!-- Navigator Section -->
                <div class="pu-build-section">
                    <div class="pu-build-section-label">NAVIGATE</div>
                    <div data-testid="pu-build-navigator"></div>
                </div>

                <!-- Export Section -->
                <div class="pu-build-section">
                    <div class="pu-build-section-label">EXPORT</div>
                    <div data-testid="pu-build-export-section">
                        <div class="pu-build-export-controls">
                            <button class="pu-btn pu-btn-primary" data-testid="pu-build-export-btn"
                                    onclick="PU.buildComposition.exportTxt()">Export .txt</button>
                        </div>
                        <div class="pu-build-export-estimate" data-testid="pu-build-export-estimate"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Extension Picker Popup (hidden by default) -->
        <div class="pu-ext-picker-popup" data-testid="pu-ext-picker-popup" style="display: none;">
            <div class="pu-ext-picker-header">
                <span>Select Extension</span>
                <button class="pu-ext-picker-close" data-testid="pu-ext-picker-close-btn"
                        onclick="PU.rightPanel.closeExtPicker()">&times;</button>
            </div>
            <div class="pu-ext-picker-search">
                <input type="text" data-testid="pu-ext-picker-search"
                       placeholder="Search extensions..."
                       oninput="PU.rightPanel.filterExtPicker(this.value)">
            </div>
            <div class="pu-ext-picker-tree" data-testid="pu-ext-picker-tree">
                <!-- Tree rendered by JS with data-testid="pu-ext-picker-item-{id}" per item -->
            </div>
            <div class="pu-ext-picker-actions">
                <button class="pu-btn" data-testid="pu-ext-picker-cancel-btn"
                        onclick="PU.rightPanel.closeExtPicker()">Cancel</button>
            </div>
        </div>

        <!-- Export Modal (hidden by default) -->
        <div class="pu-modal-overlay" data-testid="pu-export-modal" style="display: none;">
            <div class="pu-modal">
                <div class="pu-modal-header">
                    <h2>Export jobs.yaml</h2>
                    <button class="pu-modal-close" onclick="PU.actions.closeExportModal()">&times;</button>
                </div>
                <div class="pu-modal-body">
                    <div class="pu-export-preview" data-testid="pu-export-preview">
                        <pre><code>Loading...</code></pre>
                    </div>
                    <div class="pu-export-validation" data-testid="pu-export-validation">
                        <!-- Validation messages -->
                    </div>
                    <div class="pu-export-options">
                        <label class="pu-radio">
                            <input type="radio" name="export-mode" value="save" checked data-testid="pu-export-save-folder">
                            Save to jobs/ folder
                        </label>
                        <label class="pu-radio">
                            <input type="radio" name="export-mode" value="download" data-testid="pu-export-download">
                            Download as file
                        </label>
                    </div>
                </div>
                <div class="pu-modal-footer">
                    <button class="pu-btn" data-testid="pu-export-cancel-btn" onclick="PU.actions.closeExportModal()">
                        Cancel
                    </button>
                    <button class="pu-btn pu-btn-primary" data-testid="pu-export-confirm-btn" onclick="PU.actions.confirmExport()">
                        Export
                    </button>
                </div>
            </div>
        </div>

        <!-- Save as Theme Modal -->
        <div class="pu-modal-overlay" data-testid="pu-theme-save-modal" style="display: none;">
            <div class="pu-modal">
                <div class="pu-modal-header">
                    <h2>Save as Theme</h2>
                    <button class="pu-modal-close" onclick="PU.themes.closeSaveModal()">&times;</button>
                </div>
                <div class="pu-modal-body">
                    <label>Theme Name
                        <input type="text" data-testid="pu-theme-save-name" placeholder="my-theme">
                    </label>
                    <label>Folder
                        <select data-testid="pu-theme-save-folder"></select>
                    </label>
                    <div class="pu-theme-save-preview" data-testid="pu-theme-save-preview"></div>
                </div>
                <div class="pu-modal-footer">
                    <button class="pu-btn" onclick="PU.themes.closeSaveModal()">Cancel</button>
                    <button class="pu-btn pu-btn-primary" data-testid="pu-theme-save-confirm"
                            onclick="PU.themes.confirmSave()">Save</button>
                </div>
            </div>
        </div>

        <!-- Move to Theme Modal -->
        <div class="pu-modal-overlay" data-testid="pu-move-to-theme-modal" style="display: none;">
            <div class="pu-modal" data-testid="pu-mtt-modal">
                <div class="pu-modal-header">
                    <h2>Move to Theme</h2>
                    <button class="pu-modal-close" data-testid="pu-mtt-close-btn" onclick="PU.moveToTheme.close()">&times;</button>
                </div>
                <div class="pu-modal-body" data-testid="pu-mtt-body">
                </div>
                <div class="pu-modal-footer">
                    <button class="pu-btn" data-testid="pu-mtt-cancel-btn" onclick="PU.moveToTheme.close()">Cancel</button>
                    <button class="pu-btn pu-btn-primary" data-testid="pu-mtt-confirm-btn" onclick="PU.moveToTheme.confirm()">Move</button>
                </div>
            </div>
        </div>

        <!-- Popup backdrop overlay (click-outside dismiss for popups) -->
        <div class="pu-popup-overlay" data-testid="pu-popup-overlay"></div>

        <!-- Backdrop overlay (mobile/tablet panel dismiss) -->
        <div class="pu-backdrop" data-testid="pu-backdrop"></div>

        <!-- Toast Container -->
        <div class="pu-toast-container" data-testid="pu-toast-container"></div>
    </div>

    <!-- Scripts -->
    <script src="vendor/quill/quill.js"></script>
    <script src="js/state.js"></script>
    <script src="js/quill-wildcard.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/blocks.js"></script>
    <script src="js/annotations.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/right-panel.js"></script>
    <script src="js/preview.js"></script>
    <script src="js/focus.js"></script>
    <script src="js/wildcard-popover.js"></script>
    <script src="js/build-composition.js"></script>
    <script src="js/themes.js"></script>
    <script src="js/move-to-theme.js"></script>
    <script src="js/export.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
